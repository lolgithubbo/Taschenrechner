<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Taschenrechner</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111827" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --accent: #22c55e;
      --danger: #ef4444;
      --radius: 18px;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    body {
      margin: 0; font-family: system-ui, sans-serif;
      background: var(--bg); color: var(--text);
      display: grid; place-items: center; min-height:100vh;
    }
    .app { width: min(500px,100%); padding: 16px; }
    .card { background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px; }
    header h1 { font-size: 18px; margin: 0; }
    .display { background:#0b1220; border-radius: var(--radius); padding:16px; min-height:92px; display:flex; flex-direction:column; align-items:flex-end; justify-content:flex-end; }
    .expr { font-size:14px; color:#94a3b8; }
    .result { font-size:32px; font-variant-numeric:tabular-nums; }
    .grid { margin-top:14px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    button { border:0; border-radius:14px; padding:16px; font-size:18px; font-weight:600; background:#1f2937; color:var(--text); cursor:pointer; }
    button:active { transform:scale(.98); }
    .accent { background: var(--accent); color:white; }
    .danger { background: var(--danger); color:white; }
    .wide { grid-column: span 2; }
    .tools { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .history { margin-top:14px; background:#1f2937; border-radius:12px; padding:10px; max-height:200px; overflow:auto; }
    .history h3 { margin:0 0 6px; font-size:14px; color:#94a3b8; }
    /* Theme chooser */
    #color-toggle { width:24px; height:24px; border-radius:4px; border:2px solid white; cursor:pointer; }
    .color-panel { display:none; position:absolute; top:50px; right:20px; background:var(--panel); padding:10px; border-radius:12px; box-shadow:var(--shadow); grid-template-columns:repeat(4,1fr); gap:8px; }
    .color-panel.open { display:grid; }
    .color-btn { width:28px; height:28px; border-radius:6px; cursor:pointer; border:2px solid white; }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <h1>ðŸ§® Taschenrechner</h1>
        <div style="position:relative;">
          <div id="color-toggle"></div>
          <div class="color-panel" id="color-panel"></div>
        </div>
      </header>
      <div class="display">
        <div id="expr" class="expr">&nbsp;</div>
        <div id="result" class="result">0</div>
      </div>
      <div class="grid" id="keys"></div>
      <div class="tools">
        <button id="m-plus">M+</button>
        <button id="m-minus">Mâˆ’</button>
        <button id="m-recall">MR</button>
        <button id="m-clear">MC</button>
      </div>
      <div class="history">
        <h3>Verlauf</h3>
        <ul id="history-list" style="list-style:none;padding:0;margin:0;font-size:14px;"></ul>
      </div>
    </div>
  </div>
<script>
  const exprEl = document.getElementById('expr');
  const resultEl = document.getElementById('result');
  const keys = document.getElementById('keys');
  const historyList = document.getElementById('history-list');
  const colorToggle = document.getElementById('color-toggle');
  const colorPanel = document.getElementById('color-panel');

  const keyLayout = [
    ['AC','DEL','%','/'],
    ['7','8','9','*'],
    ['4','5','6','-'],
    ['1','2','3','+'],
    ['0','.','=']
  ];

  let expression = '';
  let memory = 0;
  let history = JSON.parse(localStorage.getItem('history')||'[]');
  let theme = localStorage.getItem('theme')||'green';

  const themes = {
    green:{accent:'#22c55e',bg:'#0f172a',panel:'#111827'},
    blue:{accent:'#3b82f6',bg:'#0f172a',panel:'#111827'},
    red:{accent:'#ef4444',bg:'#0f172a',panel:'#111827'},
    purple:{accent:'#8b5cf6',bg:'#0f172a',panel:'#111827'},
    pink:{accent:'#ec4899',bg:'#0f172a',panel:'#111827'},
    orange:{accent:'#f97316',bg:'#0f172a',panel:'#111827'},
    yellow:{accent:'#eab308',bg:'#0f172a',panel:'#111827'},
    teal:{accent:'#14b8a6',bg:'#0f172a',panel:'#111827'},
    cyan:{accent:'#06b6d4',bg:'#0f172a',panel:'#111827'},
    indigo:{accent:'#6366f1',bg:'#0f172a',panel:'#111827'},
    dark:{accent:'#22c55e',bg:'#0f172a',panel:'#111827'},
    light:{accent:'#3b82f6',bg:'#f9fafb',panel:'#e5e7eb',text:'#111827'}
  };

  function applyTheme(name){
    const t = themes[name]||themes.green;
    document.documentElement.style.setProperty('--accent',t.accent);
    document.documentElement.style.setProperty('--bg',t.bg);
    document.documentElement.style.setProperty('--panel',t.panel);
    if(t.text){ document.documentElement.style.setProperty('--text',t.text); } else { document.documentElement.style.setProperty('--text','#e5e7eb'); }
    localStorage.setItem('theme',name);
    colorToggle.style.background = t.accent;
  }

  function formatNumber(n){ const num = Number(n); return isFinite(num)? num.toString() : 'Error'; }
  function sanitize(expr){ expr=expr.replace(/,/g,'.').replace(/Ã—/g,'*').replace(/Ã·/g,'/'); expr=expr.replace(/(\\d+(?:\\.\\d+)?)%/g,'($1/100)'); return expr; }
  function evaluate(){ try{ return formatNumber(Function('return '+sanitize(expression))()); }catch{ return 'Error'; } }

  function updateDisplay(){ exprEl.textContent=expression||' '; resultEl.textContent=evaluate(); }
  function press(key){
    if(key==='AC'){expression='';updateDisplay();return;}
    if(key==='DEL'){expression=expression.slice(0,-1);updateDisplay();return;}
    if(key==='='){const res=evaluate();if(res!=='Error'){history.unshift(expression+' = '+res);history=history.slice(0,10);localStorage.setItem('history',JSON.stringify(history));renderHistory();expression=res;}updateDisplay();return;}
    expression+=key; updateDisplay();
  }

  keys.innerHTML = keyLayout.map(row => row.map(k=>{
    let cls='';
    if(k==='AC')cls='danger';
    if(k==='=')cls='accent';
    return `<button class=\"${cls}\" data-key=\"${k}\">${k}</button>`;
  }).join('')).join('');

  keys.addEventListener('click',e=>{
    if(e.target.dataset.key) press(e.target.dataset.key);
  });

  function renderHistory(){
    historyList.innerHTML='';
    history.forEach(item=>{
      const li=document.createElement('li');
      li.textContent=item;
      li.onclick=()=>{ expression=item.split('=')[1].trim(); updateDisplay(); }
      historyList.appendChild(li);
    });
  }
  renderHistory();

  // Memory
  document.getElementById('m-plus').onclick=()=>{memory+=Number(evaluate())||0;};
  document.getElementById('m-minus').onclick=()=>{memory-=Number(evaluate())||0;};
  document.getElementById('m-recall').onclick=()=>{expression+=memory;updateDisplay();};
  document.getElementById('m-clear').onclick=()=>{memory=0;};

  // Farb-Panel Buttons generieren
  colorPanel.innerHTML = Object.keys(themes).map(t=>`<div class=\"color-btn\" style=\"background:${themes[t].accent}\" data-theme=\"${t}\"></div>`).join('');
  colorPanel.onclick=(e)=>{ if(e.target.dataset.theme){ applyTheme(e.target.dataset.theme); colorPanel.classList.remove('open'); } };

  colorToggle.onclick=()=>{ colorPanel.classList.toggle('open'); };

  applyTheme(theme);

  // PWA Service Worker
  if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
  updateDisplay();
</script>
</body>
</html>
